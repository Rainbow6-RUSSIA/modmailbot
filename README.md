# Администраторская почта для Discord
[Discord](https://discordapp.com/)-бот, позволящий пользователям через ЛС бота связываться с со всеми администраторами сервера.
Эти ЛС перенаправляются в сервер-ящик, где на каждого пользователя будет открыт собственный канал ("тред").
Администратоы смогут ответить в треде, и эти ответы будут возвращены ботом в ЛС пользователя.

Вдохновлено админской почтой Reddit'а.

## Установка
1. Установить Node.js 8.9.4 (LTS) или выше.
2. Склонируйте или скачайте этот репозиторий.
3. Создайте сервер в Discord, который будет использоваться в роли почтового ящика.
4. Сделайте копию `config.example.json` и назовите `config.json` (или `config.js` для использования ENV переменных). Откройте файл и заполните значения указанные в конце страницы.
5. Установите зависимости: `npm install`.
6. Добавьте бота на необходимые сервера и убедитесь, что дали ему права на сервере-ящике.
7. Запустите: `npm start`.

## Список изменений
Смотри [CHANGELOG.md](CHANGELOG.md)

## Команды

##### Команды для использования в почтовом ящике - сервере
`!logs <user>` Вывести предыдущие логи сообщений пользователя
`!block <user>` Заблокировать пользователя в почте
`!unblock <user>` Разблокировать пользователя в почте
`!s <shortcut> <text>` Добавить шаблон. Использование:
`!edit_snippet <shortcut> <text>` Редактировать шаблон (алиас `!es`)
`!delete_snippet <shortcut>` Удалить шаблон (алиас`!ds`)
`!snippets` Вывести список шаблонов
`!version` Вывести версию бота
`!newthread <user>` Открыть новый тред с указанным пользователем

##### Команды для использования в треде
`!reply <text>` Ответить пользователю по формату "(Role) User: text" (алиас `!r`)
`!anonreply <text>` Ответить анонимно пользователю по формату "Role: text" (алиас`!ar`)
`!close <time>` Закрыть тред. Если указано время, то закрытие будет запланировано. Если происходит обмен сообщением, то закрытие отменяется.
`!logs` Вывести предыдущие логи сообщений пользователя
`!block` Заблокировать пользователя в почте
`!unblock` Разблокировать пользователя в почте
`!!shortcut` Ответить шаблоном. Замените `shortcut` названием шаблона.
`!!!shortcut`  Ответить анонимно шаблоном. Замените `shortcut` названием шаблона.
`!move <category>` Переместить тред в другую категорию
`!loglink` Вывести ссылку на лог текущего треда
`!suspend` Заморозить тред. Тред будет отображаться как закрытый и не будет принимать сообщения до разморозки.
`!unsuspend` Разморозить тред.
`!id` Вывести ID пользователя
`!alert` Упомянуть, когда появится новое сообщение. Используйте `!alert cancel` для отмены.

## Настройки `config.json`
Пример: `config.example.json`.

|Параметр|По умолчанию|Описание|
|------|-------|-----------|
|**token**|Не указано|**Обязательно!** Токен бота.|
|**logChannelId**|Не указано|**Обязательно!** Канал для постинга логов закрытых тредов и прочих уведомлений.|
|**mailGuildId**|Не указано|**Обязательно!** ID сервера-ящика.|
|**mainGuildId**|Не указано|**Обязательно!** ID (или массив ID) главного сервера откуда будут обращаться пользователи. Используется для отображения серверных никнеймов, дат присоединения и перехват упоминаний бота.|
|accountAgeDeniedMessage|"Your Discord account is not old enough to contact modmail."|Смотри `requiredAccountAge` далее.|
|allowMove|false|Если включено, то позволяет перенести тред в категорию каналов. Использование `!move <category>`.|
|syncPerms|false|Если включено, то при перемещении треда в другую категорию, права канала будут синхронизированы с правами категории.|
|allowUserClose|false|Если включено, то пользователи смогут самостоятельно закрывать тред в ЛС бота.|
|alwaysReplyAnon|false|Если включено `alwaysReply`, то автоматический ответ будет анонимным.|
|alwaysReply|false|Если включено, то все сообщения не начинающиеся с префикса `!` (по умолчанию) будут автоматически отправлены пользователю, даже без `!r`|
|botMentionResponse|Не указано|Если указано, то бот будет отвечать этим сообщением на свое упоминание.|
|closeMessage|Не указано|Сообщение, отправляемое пользователю при закрытии треда.|
|enableGreeting|false|Если включено, то новые пользователи будут получать приветственное сообщение при присоединении.|
|greetingAttachment|Не указано|Путь к изображению или другому файлу для прикрепления к приветственному сообщению.|
|greetingMessage|Не указано|Текст приветственного сообщения|
|ignoreAccidentalThreads|false|Если включено, то бот попытается игнорировать сообщения по типу "привет", "спасибо" и т.д.|
|inboxServerPermission|Не указано|Необходимые права пользователя для использования бота на сервере-ящике.|
|mentionRole|"here"|Роль, которая будет упомянута при создании нового треда или упоминании бота. Принимает "here", "everyone" или ID роли. Укажите `null` чтобы полностью отключить упоминания.|
|mentionUserInThreadHeader|false|Если включено, то обратившийся пользователь будет упомянут в шапке треда.|
|newThreadCategoryId|Не указано|ID категории каналов куда будут помещаться открываемые треды.|
|pingOnBotMention|true|Если включено, то бот упомянет администраторов на сервере-ящике (смотри mentionRole выше) при упоминании бота на основном сервере.|
|port|8890|Порт веб-сервера логов и приложений.|
|prefix|"!"|Префикс команд бота.|
|relaySmallAttachmentsAsAttachments|false|Если включено, то бот будет пересылать небольшие приложения как приложения, а не как ссылку на файл приложения на веб-сервере.|
|requiredAccountAge|Не указано|Требуемый возраст аккаунта для отправки сообщений в почту (в часах). Если возраст не достигнут, то тред не будет создан, а пользователь получит сообщение, указанное в `accountAgeDeniedMessage` (если указано).|
|responseMessage|"Thank you for your message! Our mod team will reply to you here as soon as possible."|Ответ бота пользователю при начале нового треда.|
|smallAttachmentLimit|2097152|Лимит приложения для пересылки приложением в байтах (по умолчанию 2MB). Смотри `relaySmallAttachmentsAsAttachments` выше.|
|snippetPrefix|"!!"|Префикс для использования шаблонов.|
|snippetPrefixAnon|"!!!"|Префикс для анонимного использования шаблонов.|
|status|"Message me for help"|Текст статуса бота.|
|threadTimestamps|false|Если включено, то бот будет добавлять временную метку к сообщениям в треде в добавление к метке Discord. В веб-логах метка дублироваться не будет.|
|typingProxy|false|Если включено, то бот будет показывать в треде "%botname% печатает" когда, обращающийся пользователь будет набирать сообщение.|
|typingProxyReverse|false|Аналогично `typingProxy`, только в обратном направлении.|
|url|Не указано|URL веб-сервера для вставки ссылок на приложения и логи. По умолчанию `IP:PORT`|
|useNicknames|false|Если включено, то при обычном ответе вместо никнейма администратора будет указан никнейм на сервере-ящике.|
|storage|"pg"|Тип используемой базы данных. Смотри https://knexjs.org/#Installation|
|dbConnection|process.env.DATABASE_URL|Объект или строка соединения с базой данных. Смотри https://knexjs.org/#Installation-client|
